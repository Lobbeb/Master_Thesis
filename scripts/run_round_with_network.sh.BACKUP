#!/usr/bin/env bash
set -euo pipefail

if [ $# -lt 3 ]; then
  echo "Usage: $0 <run_id_or_meta_dir> <delay_ms> <loss_percent> [jitter_ms]"
  exit 2
fi

RUN_ID="$1"
DELAY_MS="$2"
LOSS_PCT="$3"
JITTER_MS="${4:-10}"

source "$(dirname "$0")/env.sh"

# Expect run_round.sh run_id format; reuse it and set condition=impaired
# Store network params in meta.yaml afterwards
bash scripts/run_round.sh "$RUN_ID" "impaired" "dji0" "orchard"

META="${HOME}/runs/${RUN_ID}/meta.yaml"
if [ -f "$META" ]; then
  cat >> "$META" << EOF
network:
  enabled: true
  delay_ms: ${DELAY_MS}
  jitter_ms: ${JITTER_MS}
  loss_percent: ${LOSS_PCT}
EOF
fi

echo "NOTE: To actually impair topics, start the node in parallel:"
echo "  ros2 run lrs_omnet_bridge network_impairment_node --ros-args -p enabled:=true -p delay_ms:=${DELAY_MS} -p delay_stddev_ms:=${JITTER_MS} -p packet_loss_percent:=${LOSS_PCT}"
